version: '3'

tasks:
  clean-modules:
    desc: ğŸ§¹ Nettoie le cache des modules npm
    cmds:
      - rm -rf node_modules
      - rm -rf ~/.npm/_cacache
      - echo "âœ… Cache npm nettoyÃ©!"

  install:
    desc: ğŸ“¦ Installe les dÃ©pendances
    deps: [clean-modules]
    cmds:
      - npm install --legacy-peer-deps
      - echo "âœ… DÃ©pendances installÃ©es avec succÃ¨s!"

  dev:
    desc: ğŸš€ Lance le serveur de dÃ©veloppement
    deps: [install]
    cmds:
      - npm run dev

  build:
    desc: ğŸ”¨ Construit l'extension
    deps: [install]
    cmds:
      - npm run build

  test:
    desc: ğŸ§ª Lance les tests
    deps: [install]
    cmds:
      - npm run test

  lint:
    desc: ğŸ” VÃ©rifie le code avec ESLint
    deps: [install]
    cmds:
      - npm run lint

  format:
    desc: âœ¨ Formate le code avec Prettier
    deps: [install]
    cmds:
      - npm run format

  docker-build:
    desc: ğŸ³ Construit l'image Docker
    deps: [build]
    cmds:
      - docker build -t modern-argocd-appset-extension:latest .

  docker-dev:
    desc: ğŸ³ Lance le serveur de dÃ©veloppement dans Docker
    cmds:
      - docker-compose up dev

  docker-run:
    desc: ğŸ³ Lance l'extension dans Docker
    deps: [build]
    cmds:
      - docker-compose up -d extension
      - echo "âœ… Extension disponible sur http://localhost:8080/extensions/modern-argocd-appset-extension"

  deploy-local:
    desc: ğŸ“¦ DÃ©ploie l'extension dans un ArgoCD local
    deps: [build]
    cmds:
      - echo "ğŸ“¦ Copie des fichiers vers le rÃ©pertoire de l'extension ArgoCD..."
      - mkdir -p ~/.argocd/extensions/modern-argocd-appset-extension
      - cp -r dist/* ~/.argocd/extensions/modern-argocd-appset-extension/
      - echo "âœ… Extension dÃ©ployÃ©e localement avec succÃ¨s!"

  deploy-k8s:
    desc: ğŸš€ DÃ©ploie l'extension dans un cluster Kubernetes
    deps: [build]
    cmds:
      - echo "ğŸš€ DÃ©ploiement de l'extension dans le cluster Kubernetes..."
      - chmod +x scripts/deploy.sh
      - ./scripts/deploy.sh
      - echo "âœ… Extension dÃ©ployÃ©e dans Kubernetes avec succÃ¨s!"

  clean:
    desc: ğŸ§¹ Nettoie les fichiers gÃ©nÃ©rÃ©s
    cmds:
      - rm -rf dist
      - rm -rf node_modules
      - rm -rf coverage
      - echo "ğŸ§¹ Projet nettoyÃ© avec succÃ¨s!"

  clean-docker:
    desc: ğŸ§¹ ArrÃªte et supprime les conteneurs Docker
    cmds:
      - docker-compose down
      - echo "ğŸ§¹ Conteneurs Docker arrÃªtÃ©s et supprimÃ©s!"

  watch-logs:
    desc: ğŸ“‹ Surveille les logs des conteneurs
    cmds:
      - docker-compose logs -f

  default:
    desc: ğŸ“‹ Liste les tÃ¢ches disponibles
    cmds:
      - task --list
